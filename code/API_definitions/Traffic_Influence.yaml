openapi: 3.0.0
############################################################################
#                                     API info                             #
############################################################################
info:
  title: OPAG-CAMARA Traffic Influence API
  version: 0.8.0
  description: |
    ## Overview
    
    The reference scenario foresees a Service provided by many Application Server instances deployed in different geographical location on Telco Operator Edge sites (MEC sites).
    The Traffic Influence API provides the fastest routing from the user equipment (e.g. a Smartphone) to the optimal Edge Application Server (EAS) Instance in a specific geographical location.
    If a Service is offered by a Cloud Instance and by Edge Instances, the API can be used to route a selected set of users on the Edge Instance.
    
    ## 1. Introduction
   
    The Traffic Influence API provides the capability to establish the best connectivity, in terms of latency, in a specific geographical area, between the User Equipment (UE), e.g. the userâ€™s smartphone, and the optimal Edge Application Server instance nearby.
    The Service architecture foresees one or more EASs and a component, the Application Function (AF), that is the API consumer. Invoking the TI API, the AF can create a "TrafficInfluence" resource specifying the desired request.
    The TI API provider implements the intent specified in the Traffic Influence resource.
    While the API is usually invoked to activate the fastest routing for any user,  it can also be used to request the routing for a specific user. Invoking the API for each user (using the same "trafficInfluenceID"), the TrafficInfluence resource provides the requested routing for a set of users.
    
    ## 2. Quick Start
    The usage of the Traffic Influence API is based on the management of a "TrafficInfluence" resource, an object containing the intent requested invoking the Traffic Influence API and that is implemented by the platform configuring the Mobile Network for the optimal routing toward the EAS Instance.
    The Traffic Influence resource can be created (providing the related parameters that specify the desired intent), queried, modified and deleted.
    The API is asynchronous, a notification is available providing information about the status of the requested resource.  
    
    Before starting to use the API, the developer needs to know about the below specified details:
   
    **Base-Url**
    The RESTful Traffic Influence API endpoint, for example [**https://tim-api.developer.tim.it/trafficinfluence**](https://tim-api.developer.tim.it/trafficinfluence)
   
    **Authentication**
    Configure security access keys such as OAuth 2.0 client credentials to be used by Client applications which will invoke the Traffic InfluenceAPI.
   
    **TrafficInfluence**
    This object represents the resource that carries the requirements from the user to be implemented. The Traffic Influence API is invoked for the life cycle management of this resource (CRUD). The resource contains the intents from the API Consumer. Managing this resource, the developer can specify in which geographical location the routing must be applied, toward which application,  maybe for a specific set of users or for a limited period pf time.
   
    **trafficInfluenceID**
    Identifier for the Traffic Influence resource. This parameter ir returned by the API and must be used to update it (e.g., adding new users or deleting it)
    
    **applicationFunctionId**
    Unique identifier for the Application Function (AF), the TI API consumer.
    
    **region**
    The developer can specify in which geographical area he requires the fastest routing toward the nearest application instance. A Region is a wide geographical area and it contains one ore more Zones. A Zone is where the Edge Datacenters are located.
    
    **zone**
    The developer can specify in which geographical area he requires the fastest routing toward the nearest application instance. A Zone is a smaller geographical area inside a Region. A Zone is where the Edge Datacenters are located.
    
    **applicationId**
    Unique Application identifier inside the Telco Operator Platform.
   
    **trafficFilters**
    The Application can expose different service on different interfaces, with this parameter it is possible to enable just some of those services maybe for different sets of users.
   
    **usersId**
    Optionally a user can be provided as an input. The routing toward the selected Application Instance is only applied for that user. To add more users the API must be invoked of each one always passing the reference to the same Traffic Influence resource (trafficInfluenceID)   
   
    **Notification URL and token**
    Developers have a chance to specify callback URL on which notifications (eg. session termination) regarding the session can be received from the service provider. This is also an optional parameter.
          
    ## 3. Authentication and Authorization
    The Traffic Influence API makes use of the client credentials grant which is applicable for server to server use cases involving trusted partners or clients without any protected user data involved.
    In this method the API invoker client is registered as a confidential client with an authorization grant type of client\_credentials [2].
    
    ## 4. API Documentation
    ## 4.1 Details
    
    The Traffic Influence (TI) API is consumed by an Application Function (AF) requesting for the fastest routing of the traffic flow from the User Equipments toward an instance of the Edge Application Server (EAS) in a Telco Operator Edge sites (MEC sites).
    
    When the EAS is onboarded and deployed in the MEC site, the Application is identified with a unique identifier (applicationId). 
    
    Using the application identifier ("applicationId") and specifying a Zone or a Region, the Telco Operator Platform, autonomously identifies the best instance of the EAS toward routing the traffic flow and configures the Mobile Network accordingly to get the fastest routing.
    If just the application identifier is used, the Telco Operator Platform  identifies all the EAS Instances and activates the optimal routing on the Mobile Network.
    If the fastest routing should be available just for a set of users, the API must be invoked for each user also passing the same TrafficInfluce resource identifier ("trafficInfluenceID")
    If the Application offers different services on different interfaces a  traffic filter based on IP, Port and Protocol can be used. I this way it is also possible to redirect different users to different interfaces.
   
    Here are some possible intents:
    1) activate the optimal routing for any EAS Instance: the API must be invoked with the applicationId. The Telco Operator Platform identifies all the EAS Instances and activates the optimal routing on the Mobile Network.
    2) activate the optimal routing in a specific Region or Zone: the API must be invoked with the applicationId and the Zones and Regions identifiers. 
    3) activate the optimal routing for a specific set of users: the API can also be invoked with a user identifier ("userId"). The same TrafficInfluce resource identifier ("trafficInfluenceID") must be used in each call.
    
    
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

externalDocs:
  description: Product documentation at Camara
  url: https://github.com/camaraproject/
  
  
############################################################################
#                                     Security                             #
############################################################################
security:
  - oAuth2:
      - 'edge:traffic-influences:read'
      - 'edge:traffic-influences:write'

############################################################################
#                                     Servers                              #
############################################################################
servers:
  - url: "{apiRoot}/{basePath}"
    variables:
      apiRoot:
        default: http://localhost:9091
        description: API root
      basePath:
        default: ti/v0
        description: Base path for the Traffic Influence API



############################################################################
#                                     Paths                                #
############################################################################
paths:
  /traffic-influences:
    get:
      tags:
        - Traffic Influence API GET Operation
      summary: Retries existing TrafficInfluence Resources
      description: Reads all of the active TrafficInfluence resources owned by the AF authenticated via oAuth2
      operationId: GetTrafficInfluences
      responses:
        '200':
          description: Returns the information about existing TrafficInfluence resources. 
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TrafficInfluence"
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
        '500':
          $ref: "#/components/responses/GenericError"
        "503":
          $ref: "#/components/responses/Generic503"
        '504':
          $ref: "#/components/responses/BackendConnTimeout"
          
    post:
      tags:
        - Traffic Influence API POST Operation
      summary: Creates a new TrafficInfluence resource
      description: Gets in input an object containing the intents from the AF and creates a TrafficInfluence resourse accordingly. 
      operationId: PostTrafficInfluence
      requestBody:
        description: Describes the request body
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrafficInfluence'

      responses:
        '201':
          description: TrafficInfluence resource created, the related object is returned with the resource ID (TIResource_id) valorised 
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrafficInfluence'

        '500':
          $ref: '#/components/responses/GenericError'
        '504':
          $ref: '#/components/responses/BackendConnTimeout'
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
        "503":
          $ref: "#/components/responses/Generic503"
      callbacks:
        onTrafficInfluenceChanged:
          $ref: "#/components/callbacks/onTrafficInfluenceChanged"
  /traffic-influences/{TIResource_id}:
    parameters:
      - name: TIResource_id
        in: path
        description: Identifier of the specific TrafficInfluence resource to be retrieved, modified or deleted
        required: true
        schema:
          type: string
   
    get:
      summary: read a specific TrafficInfluence resource identified by TIResource_id
      tags:
        - Traffic Influence API GET Operation
      responses:
        '200':
          description: OK. 
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrafficInfluence'
        '404':
          $ref: '#/components/responses/ResNotFound'
        '500':
          $ref: '#/components/responses/GenericError'
        '504':
          $ref: '#/components/responses/BackendConnTimeout'
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
        "503":
          $ref: "#/components/responses/Generic503"
    put:
      tags:
        - TrafficInfluence API PUT Operation
      summary: updates a specific TrafficInfluence resource, identified by TIResource_id
      description: The resource identified by TIResource_id can be modified, e.g. to add new users or to modify the validity time period
      operationId: PutTrafficInfluence
      requestBody:
        description: Describes the request body
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrafficInfluence'
      responses:
        '200':
          description: OK. 
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrafficInfluence'
        '404':
          $ref: '#/components/responses/ResNotFound'
        '500':
          $ref: '#/components/responses/GenericError'
        '504':
          $ref: '#/components/responses/BackendConnTimeout'
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
        "503":
          $ref: "#/components/responses/Generic503"
      callbacks:
        onTrafficInfluenceChanged:
          $ref: "#/components/callbacks/onTrafficInfluenceChanged"
    delete:
      summary: Delete an existing TrafficInfluence resource
      tags:
        - TrafficInfluence API Delete Operation
      parameters:
        - name: callbackUrl
          in: query
          required: false
          description: |
            the location where updated data will be sent.  Must be network accessible
            by the source server
          schema:
            type: string
            format: uri
            example: https://my-notification-server.com
      responses:
        '200':
          $ref: '#/components/responses/OkDeleted'
        '404':
          $ref: '#/components/responses/ResNotFound'
        '504':
          $ref: '#/components/responses/BackendConnTimeout'
        "401":
          $ref: "#/components/responses/Generic401"
        "403":
          $ref: "#/components/responses/Generic403"
        "503":
          $ref: "#/components/responses/Generic503"
      callbacks:
        onTrafficInfluenceChanged:
          $ref: "#/components/callbacks/onTrafficInfluenceChanged"

components:
  securitySchemes:
    oAuth2:    
      type: oauth2
      description: This API uses OAuth 2 [More info](https://api.example.com/docs/auth)
      flows:        
        clientCredentials:
          tokenUrl: 'https://example.com/oauth/token'
          scopes:
            'edge:traffic-influences:read': Grant read-only traffic-influences data
            'edge:traffic-influences:write': Grant write access to traffic-influences data

 #######################################################
 #  EVENTS/CALLBACKS
 #######################################################
  callbacks:
    onTrafficInfluenceChanged:
          # when data is sent, it will be sent to the `callbackUrl` provided
          # when making the subscription PLUS the suffix `/event`
          '{$request.body.notificationUri}/event':
            post:
              requestBody:
                description: subscription payload which contains the updated traffic influence instance
                content:
                  application/json:
                    schema:
                      $ref: '#/components/schemas/TrafficInfluenceNotification'
              responses:
                  '202':
                    description: |
                      Your server implementation should return this HTTP status code
                      if the data was received successfully
                  '204':
                    description: |
                      Your server should return this HTTP status code if no longer interested
                      in further updates
 #######################################################
 #  RESOURCES
 #######################################################
  
  schemas: 
    TrafficInfluenceNotification:
      type: object
      required:
        - trafficInfluenceChanged
      properties:
        trafficInfluenceChanged:
          $ref: "#/components/schemas/TrafficInfluence"

    TrafficInfluence:
      type: object
      properties:
        trafficInfluenceID:
          type: string
          description: Defines the local breakout required for the particular Telco Edge Node and Service Edge Node. I.E. TurinEast, TurinNorth
        applicationFunctionId:
            type: string
            description: Unique Identifier of the Application Function caller
        applicationId:
          type: string
          example: "Virtual_Reality_Arena"
          description:  Unique ID representing the Edge Application
        region:
            $ref: '#/components/schemas/types_region_Id'
        zone:
            $ref: '#/components/schemas/types_zone_Id'
        usersId:
          $ref: '#/components/schemas/userId'
        state:
          type: string
          enum:
            - 'ordered'
            - 'created'
            - 'active'
            - 'not active'
            - 'error'
            - 'deleted'
        trafficFilters:
          type: array
          items:
            $ref: '#/components/schemas/FlowInfo'
          minItems: 1
          description: Identifies IP packet filters. To be used when a the Application needs a traffic flow towards a specific EAS interface 
        notificationUri:
            type: string
            description: Defines the callback uri which should be notified in asynchronous way when the state for the requested resources changes (i.e. ordered to activated)
        notificationAuthToken:
            type: string
            description: Authentification token for callback API      
      required:
        - applicationFunctionId
        - applicationId
    
 #######################################################
 #  TYPES
 #######################################################    
    types_zone_Id:
      description: |
        Unique identifier representing a zone
      type: string
      additionalProperties: false  
      
    types_region_Id:
      description: |
        Unique identifier representing a region
      type: string
      additionalProperties: false   
      
    userId:
     description: User equipment identifier, it is composed by a value and a type for that value
     type: object
     minProperties: 1
     properties:
       UEIdentityType:
         $ref: "#/components/schemas/types_UEIdentityType"
       UEIdentity:
         $ref: "#/components/schemas/types_UEIdentity"
  
    types_UEIdentityType:
      description: Type of User Equipment identifier used in `UEIdentity`.
      type: string
      enum:
        - IPAddress
        - MSISDN
        - IMEI
        - MDN
        - GPSI
        
    types_UEIdentity:
      description: Identifier value for User Equipment. The type of identifier is defined by the 'UEIdentityType' parameter.
      type: string      

    FlowInfo:
      type: object
      properties:
        flowId:
          type: integer
          description: Indicates the IP flow.
        flowDescriptions:
          type: array
          items:
            type: string
          description: Indicates the packet filters of the IP flow. 
          minItems: 1
          maxItems: 2
      required:
        - flowId

 ######################################################
 #  RESPONSES
 #######################################################            
    ErrResponse:
      type: object
      properties:
        status:
          type: string
          example: OK
        message:
          type: string
          example: OK
    ErrorInfo:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Code given to this error
        message:
          type: string
          description: Detailed error description
  responses:
    ResNotFound:
      description: The specified resource was not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrResponse'
          example:
            status: ERROR
            message: Resource not found
    GenericError:
      description: An unknow error has occurred
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrResponse'
          example:
            status: ERROR
            message: Generic error
    BackendConnTimeout:
      description: Connection timeout towards backend service has occurred
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrResponse'
          example:
            status: ERROR
            message: Backend connection timeout
    OkDeleted:
      description: The resource has been successfully deleted
      content:
        application/json:
          example:
            status: OK
            message: Deleted
    Generic400:
      description: Invalid input
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorInfo"
          example:
            code: INVALID_INPUT
            message: "Schema validation failed at  ..."
    Generic401:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorInfo"
          example:
            code: UNAUTHORIZED
            message: "Authorization failed: ..."
    Generic403:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorInfo"
          example:
            code: FORBIDDEN
            message: "Operation not allowed: ..."
    SessionNotFound404:
      description: Session not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorInfo"
          example:
            code: NOT_FOUND
            message: "Session Id does not exist"
    Generic503:
      description: Service unavailable
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorInfo"
          example:
            code: SERVICE_UNAVALIBLE
            message: "Service unavailable"